# M2.2 MVP Hardening â€” Install Notes

## New files
- `src/middleware/traceId.ts`
- `src/middleware/rateLimit.ts`
- `src/middleware/idempotency.ts`
- `src/lib/retry.ts`
- `src/workers/capiWorkerRetry.ts`
- `sql/migrations/20250918_idempotency_keys.sql`
- `sql/migrations/20250918_outbox_dlq.sql`
- `postman/collections/m22-mvp-smoke.postman_collection.json`

## Minimal integration
In your Express app (e.g. `src/app.ts`):
```ts
import express from "express";
import { traceIdMiddleware } from "./middleware/traceId";
import { rateLimitMiddleware } from "./middleware/rateLimit";
import { idempotencyMiddleware } from "./middleware/idempotency";

const app = express();
app.use(express.json());
app.use(traceIdMiddleware);
app.use(rateLimitMiddleware());

// Apply idempotency only to mutation routes, e.g. /api/convert
app.post("/api/convert", idempotencyMiddleware, (req, res) => {
  // your existing convert handler
  res.json({ ok: true, traceId: req.traceId });
});

export default app;
```

## SQL
Run the two migration files on your Postgres instance.
For TTL cleanup, schedule (daily):
```sql
DELETE FROM idempotency_keys WHERE created_at < NOW() - INTERVAL '1 day';
```

## Worker
Call `processOutboxBatch()` periodically (e.g. every minute) from your worker process.
